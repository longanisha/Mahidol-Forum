# 积分系统说明文档

## 概述

Mahidol Forum 使用积分系统来激励用户参与社区活动。用户通过发布内容、互动等方式获得积分，积分可用于解锁特殊功能，并影响用户等级。

## 积分计算规则

### 获得积分

| 操作 | 积分 | 说明 |
|------|------|------|
| 每日登录 | +1 | 每天首次登录奖励，不重复计算 |
| 发布帖子 | +10 | 每次成功发布一个新帖子 |
| 发表评论 | +5 | 每次在帖子下发表评论 |
| 帖子被点赞 | +2 | 其他用户点赞你的帖子（仅限新点赞，取消或切换不奖励） |
| 评论被点赞 | +1 | 其他用户点赞你的评论（仅限新点赞，取消或切换不奖励） |

### 扣除积分

| 操作 | 积分 | 说明 |
|------|------|------|
| 置顶帖子 | -50 | 将帖子置顶需要消耗积分 |
| 创建私人群组 | -30 | 创建私人群组需要消耗积分 |

### 注意事项

1. **不能给自己点赞奖励**：用户不能通过点赞自己的内容获得积分
2. **积分不足时操作失败**：如果积分不足以执行需要消耗积分的操作，操作将被拒绝
3. **每日登录奖励**：每天只奖励一次，基于 `last_login_date` 字段判断

## 等级系统

### 等级计算公式

```
等级 = min(10, 1 + (总积分 // 100))
```

### 等级说明

- **最低等级**：1 级（0-99 积分）
- **最高等级**：10 级（900+ 积分）
- **每 100 积分升一级**

### 等级对应表

| 等级 | 所需积分范围 | 说明 |
|------|-------------|------|
| 1 | 0-99 | 新手 |
| 2 | 100-199 | 初级 |
| 3 | 200-299 | 中级 |
| 4 | 300-399 | 高级 |
| 5 | 400-499 | 资深 |
| 6 | 500-599 | 专家 |
| 7 | 600-699 | 大师 |
| 8 | 700-799 | 宗师 |
| 9 | 800-899 | 传奇 |
| 10 | 900+ | 传说 |

## 积分记录

### 记录内容

所有积分变动都会记录在 `point_records` 表中，包括：

- **id**: 记录唯一标识
- **user_id**: 用户 ID
- **points**: 积分数量（正数为获得，负数为扣除）
- **reason**: 积分原因（如"发布帖子"、"帖子被点赞"等）
- **created_at**: 记录创建时间

### 查看积分历史

用户可以在 Profile 页面的 **Points History** tab 中查看所有积分变动记录。

## 技术实现

### 核心函数

#### `award_points(supabase, user_id, points, reason)`

奖励积分给用户。

**流程**：
1. 创建积分记录（`point_records` 表）
2. 获取用户当前总积分
3. 计算新总积分：`new_total = current_points + points`
4. 计算新等级：`new_level = min(10, 1 + (new_total // 100))`
5. 更新用户资料（`profiles` 表）

#### `deduct_points(supabase, user_id, points, reason)`

扣除用户积分。

**流程**：
1. 检查用户积分是否充足
2. 创建积分记录（负数）
3. 计算新总积分：`new_total = current_points - points`
4. 计算新等级：`new_level = max(1, min(10, 1 + (new_total // 100)))`
5. 更新用户资料

#### `check_daily_login(supabase, user_id)`

检查并奖励每日登录积分。

**流程**：
1. 获取用户最后登录日期
2. 检查今天是否已登录过
3. 如果未登录，更新 `last_login_date` 为今天
4. 调用 `award_points` 奖励 1 积分

### 积分触发点

#### 帖子相关

- **发布帖子** (`backend/app/routers/threads.py:512`)
  - 触发时机：成功创建帖子后
  - 积分：+10
  - 原因："发布帖子"

- **发表评论** (`backend/app/routers/threads.py:617`)
  - 触发时机：成功创建评论后
  - 积分：+5
  - 原因："发表评论"

- **帖子被点赞** (`backend/app/routers/votes_reports.py:142`)
  - 触发时机：其他用户首次点赞帖子时
  - 积分：+2（给帖子作者）
  - 原因："帖子被点赞"
  - 注意：取消点赞或切换投票类型不奖励

- **评论被点赞** (`backend/app/routers/votes_reports.py:293`)
  - 触发时机：其他用户首次点赞评论时
  - 积分：+1（给评论作者）
  - 原因："评论被点赞"
  - 注意：取消点赞或切换投票类型不奖励

- **置顶帖子** (`backend/app/routers/threads.py:1305`)
  - 触发时机：用户请求置顶帖子时
  - 积分：-50
  - 原因："置顶帖子"
  - 注意：积分不足时操作失败

#### 登录相关

- **每日登录** (`backend/app/utils/points.py:175`)
  - 触发时机：用户登录时（需要调用 `check_daily_login`）
  - 积分：+1
  - 原因："每日登录"
  - 注意：每天只奖励一次

## 数据库结构

### `profiles` 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 用户 ID（主键） |
| total_points | INTEGER | 总积分 |
| level | INTEGER | 用户等级（1-10） |
| last_login_date | DATE | 最后登录日期（用于每日登录奖励） |

### `point_records` 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 记录 ID（主键） |
| user_id | UUID | 用户 ID（外键） |
| points | INTEGER | 积分数量（正数=获得，负数=扣除） |
| reason | TEXT | 积分原因 |
| created_at | TIMESTAMP | 创建时间 |

## API 端点

### 获取积分历史

```
GET /points/history?limit=50
```

**响应**：
```json
[
  {
    "id": "uuid",
    "user_id": "uuid",
    "points": 10,
    "reason": "发布帖子",
    "created_at": "2024-01-01T00:00:00Z"
  }
]
```

### 获取用户排名

```
GET /points/ranking
```

**响应**：
```json
{
  "ranking": 1,
  "total_users": 100,
  "total_points": 500
}
```

## 最佳实践

1. **积分奖励应在操作成功后执行**：确保操作成功后再奖励积分
2. **积分扣除应在操作前检查**：确保用户有足够积分再执行操作
3. **错误处理**：积分操作失败不应影响主要业务逻辑（如发布帖子）
4. **防止重复奖励**：对于每日登录等操作，需要检查是否已奖励
5. **记录所有变动**：所有积分变动都应记录在 `point_records` 表中

## 未来可能的扩展

- 积分商城：使用积分兑换虚拟物品或特权
- 积分任务系统：完成特定任务获得额外积分
- 积分排行榜：展示积分最高的用户
- 积分有效期：设置积分过期机制
- 更多积分来源：如分享、邀请好友等

